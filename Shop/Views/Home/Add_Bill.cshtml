@using Shop.ViewModels
@model DetailbillViewmodel

@{
    ViewData["Title"] = "เพิ่มบิล";
}
<body>
    <div class="text-center">
        <h1>@ViewData["Title"]</h1>
    </div>
    <div class="header col-3">
        <b>หมายเลขบิล : </b>
        <b id="bill_number">Bill-XXX</b>
        <br>
        <b> วันที่ : </b>
        <b id="date"></b>
    </div>


    <div class="text-center">
        <button id="add_bill">เพิ่มรายการ</button>
        <br><br>
        <table border="1" class="center" id="Mytable" value="">
            <thead>
                <tr>
                    <th> ชื่อสินค้า </th>
                    <th> หน่วย </th>
                    <th> ราคา/หน่วย </th>
                    <th> จำนวน </th>
                    <th> ราคารวม </th>
                    <th> ส่วนลด </th>
                    <th> ราคารวมหลังส่วนลด </th>
                </tr>
            </thead>
            <tbody id="table_add_bill">
            </tbody>
        </table>
        <br><br><br>
        <table class="ft">
            <tr>
                <th>ราคารวมก่อนส่วนลด :</th>
                <th id="sum_after_discount">0</th>
                <th>บาท</th>
            </tr>
            <tr>
                <th>ส่วนลดทั้งหมด :</th>
                <th id="total_discount">0</th>
                <th>บาท</th>
            </tr>
            <tr>
                <th>ราคารวมทั้งหมด :</th>
                <th id="sum_before_discount">0</th>
                <th>บาท</th>
            </tr>

        </table>
        <button id="save_bill">บันทึกรายการ</button>
    </div>



</body>
<script>
    $(document).ready(function () {
        addrow();
        setdate();
    });
    function setdate() {
        let n = new Date();
        let y = n.getFullYear() + 543;
        let m = n.getMonth() + 1;
        let d = n.getDate();
        document.getElementById("date").innerHTML = d + "/" + m + "/" + y;

    }

    function Calculate_Sum(count) {
        var sum_cal = 0;
        for (var i = 1; i <= count; i++) { //Calculate Sum
            let sum_value = document.getElementById("sum" + i).innerHTML
            if (sum_value == "") {
                sum_value = 0;
            }
            var sum_int = parseFloat(sum_value);
            sum_cal += sum_int;
        }
        document.getElementById("sum_after_discount").innerHTML = sum_cal.toFixed(2)
    }

    function Calculate_Discount(count) {
        var dis_cal = 0;
        for (var i = 1; i <= count; i++) { //Calculate Discount
            let dis_value = document.getElementById("discount" + i).value
            if (dis_value == "") {
                dis_value = 0;
            }
            var dis_int = parseFloat(dis_value);
            dis_cal += dis_int;
        }
        document.getElementById("total_discount").innerHTML = dis_cal
    }

    function Calculate_Total() {
        let dis_total = document.getElementById("total_discount").innerHTML //Calculate Total
        let sum_af = document.getElementById("sum_after_discount").innerHTML
        let sum_bf = sum_af - dis_total
        document.getElementById("sum_before_discount").innerHTML = sum_bf.toFixed(2)
    }

    function addrow() {
        axios({
            method: 'Get',
            url: '/Home/GatdataProduct',
        })
            .then(function (response) {
                console.log(response.data.billDetail)
                var count = 0;
                document.getElementById("add_bill").onclick = function () {
                    count += 1;
                    var Table = document.getElementById('Mytable');
                    var TableRow = Table.insertRow(-1);

                    //**Stat Create Select Option **//
                    var selectList = document.createElement("select");
                    selectList.id = "selectvalue" + count;
                    const cache = count;
                    selectList.onchange = function () { //ฟังก์ชัน OnChange สินค้า
                        //  let value_id = this.id;
                        var value1 = document.getElementById("selectvalue" + cache).value
                        for (let x = 0; x < response.data.product.length; x++) {
                            if (value1 == response.data.product[x].product_Id) {
                                document.getElementById("unit" + cache).innerHTML = response.data.product[x].nameUnit;
                                document.getElementById("price" + cache).innerHTML = response.data.product[x].productPrice;
                            }
                        }
                        document.getElementById("count" + cache).value = "";
                        document.getElementById("discount" + cache).value = "";
                        document.getElementById("sum" + cache).innerHTML = 0;
                        document.getElementById("total" + cache).innerHTML = 0;

                        Calculate_Sum(count);
                        Calculate_Discount(count);
                        Calculate_Total();
                    }

                    var option1 = document.createElement("option");
                    option1.id = "select" + count;
                    option1.text = "เลือกสินค้า";
                    selectList.appendChild(option1);
                    for (var i = 0; i < response.data.product.length; i++) {
                        var option = document.createElement("option");
                        option.value = response.data.product[i].product_Id;
                        option.text = response.data.product[i].nameProduct;
                        selectList.appendChild(option);
                    }
                    //**End Create Select Option **//

                    var input_count = document.createElement("input"); //สร้าง element input จำนวนสินค้า
                    input_count.id = "count" + count;
                    input_count.type = "number";
                    input_count.value = "";
                    input_count.onkeyup = function () { //ฟังก์ชัน OnKeyUp จำนวน

                        let count_product = document.getElementById("count" + cache).value
                        let price_product = document.getElementById("price" + cache).innerHTML
                        let count_pro = parseInt(count_product)
                        let price = parseFloat(price_product)
                        let sum_product = 0;
                        sum_product = price * count_pro;
                        document.getElementById("sum" + cache).innerHTML = sum_product.toFixed(2)
                        Calculate_Sum(count);
                    }

                    var unit = document.createElement("h"); //สร้าง element แสดง หน่วยสินค้า
                    unit.id = "unit" + count;
                    unit.value = "";

                    var price = document.createElement("h"); //สร้าง element แสดงราคา/ชิ้น
                    price.id = "price" + count;
                    price.value = "";

                    var sum = document.createElement("h"); //สร้าง element แสดง ราคารวม
                    sum.id = "sum" + count;
                    sum.value = "";

                    var discount = document.createElement("input");//สร้าง element input ส่วนลด
                    discount.id = "discount" + count;
                    discount.value = "";
                    discount.type = "number";
                    discount.onkeyup = function () { //ฟังก์ชัน OnKeyUp ส่วนลด
                        let sum_product = document.getElementById("sum" + cache).innerHTML
                        let discount_product = document.getElementById("discount" + cache).value
                        let total_product = 0;
                        total_product = sum_product - discount_product;
                        document.getElementById("total" + cache).innerHTML = total_product

                        Calculate_Discount(count);
                        Calculate_Total();

                    }

                    var total = document.createElement("h"); //สร้าง element แสดง ราคาทั้งหมด
                    total.id = "total" + count;
                    total.value = "";


                    var currentCell = TableRow.insertCell(-1);
                    currentCell.appendChild(selectList);  //เลือกสินค้า

                    currentCell = TableRow.insertCell(-1);
                    currentCell.appendChild(unit); // แสดงหน่วยสินค้า

                    currentCell = TableRow.insertCell(-1);
                    currentCell.appendChild(price); //แสดงราคาสินค้า

                    currentCell = TableRow.insertCell(-1);
                    currentCell.appendChild(input_count); //กรอกจำนวนสินค้า

                    currentCell = TableRow.insertCell(-1);
                    currentCell.appendChild(sum); //คิดราคา ราคารวม = ราคา*จำนวน

                    currentCell = TableRow.insertCell(-1);
                    currentCell.appendChild(discount); //กรอกส่วนลด

                    currentCell = TableRow.insertCell(-1);
                    currentCell.appendChild(total); //รวมราคาทั้งหมด ราคารวม-ส่วนลด

                    document.getElementById("save_bill").onclick = function () {

                        const arry = [];
                       
                        var sum_af_dis = document.getElementById("sum_after_discount").innerHTML
                        var sum_total_dis = document.getElementById("total_discount").innerHTML
                        var sum_bf_dis = document.getElementById("sum_before_discount").innerHTML
                       /* var name_bill_str = document.getElementById("bill_number").innerHTML*/
                        var sad = parseFloat(sum_af_dis)
                        var std = parseFloat(sum_total_dis)
                        var sbf = parseFloat(sum_bf_dis)
                        var obj = { PriceBefore: sbf, TotalDiscount: std, PriceAfter: sad}
                        arry.push(obj)

                        for (var i = 1; i <= count; i++) {
                            var sum_p = document.getElementById("sum" + i).innerHTML
                            var dis_p = document.getElementById("discount" + i).value
                            var total_p = document.getElementById("total" + i).innerHTML
                            var count_p = document.getElementById("count" + i).value
                            var value_p = document.getElementById("selectvalue" + i).value
                            //var name_bill_str = document.getElementById("bill_number").innerHTML
                            //var name_bill = name_bill_str.substring(5, 6);
                            //var nb = parseInt(name_bill)
                            var id_pro = parseInt(value_p)
                            var count_pro = parseInt(count_p)
                            var dis_pro = parseFloat(dis_p)
                            var sum_pro = parseFloat(sum_p)
                            var total_pro = parseFloat(total_p)
                            var idpro = { IdProduct: id_pro, Count: count_pro, Discount: dis_pro, TotalPrice: sum_pro, LastPrice: total_pro}
                            arry.push(idpro)
                        }
                        console.log(arry)

                        axios({
                            method: 'post',
                            dataType: 'json',
                            url: '/Home/insert_detail_bill ',
                            data: arry
                        })
                            .then(function (response) {
                                document.location = 'Detail_Bill/?id=' + response.data.idBill;
                            })
                            .catch(function (error) {
                                console.log(error);
                            });                    
                    }

                }

            });
    }
</script>
<style>


    .header {
        margin-left: 900px;
    }

    .ft {
        margin-left: 780px;
        width: 30%;
    }

    .center {
        width: 100%;
    }

    th {
        height: 50px
    }

    td {
        height: 50px
    }
</style>





